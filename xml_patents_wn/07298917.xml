<us-patent-grant lang="EN" dtd-version="v4.2 2006-08-23" file="US07298917-20071120.XML" status="PRODUCTION" id="us-patent-grant" country="US" date-produced="20071106" date-publ="20071120">
<us-bibliographic-data-grant>
<publication-reference>
<document-id>
<country>US</country>
<doc-number>07298917</doc-number>
<kind>B2</kind>
<date>20071120</date>
</document-id>
</publication-reference>
<application-reference appl-type="utility">
<document-id>
<country>US</country>
<doc-number>10372954</doc-number>
<date>20030226</date>
</document-id>
</application-reference>
<us-application-series-code>10</us-application-series-code>
<priority-claims>
<priority-claim sequence="01" kind="national">
<country>JP</country>
<doc-number>2002-327291</doc-number>
<date>20021111</date>
</priority-claim>
<priority-claim sequence="02" kind="national">
<country>JP</country>
<doc-number>2003-327290</doc-number>
<date>20021111</date>
</priority-claim>
</priority-claims>
<us-term-of-grant>
<us-term-extension>837</us-term-extension>
</us-term-of-grant>
<classifications-ipcr>
<classification-ipcr>
<ipc-version-indicator><date>20060101</date></ipc-version-indicator>
<classification-level>A</classification-level>
<section>G</section>
<class>06</class>
<subclass>K</subclass>
<main-group>9</main-group>
<subgroup>40</subgroup>
<symbol-position>F</symbol-position>
<classification-value>I</classification-value>
<action-date><date>20071120</date></action-date>
<generating-office><country>US</country></generating-office>
<classification-status>B</classification-status>
<classification-data-source>H</classification-data-source>
</classification-ipcr>
<classification-ipcr>
<ipc-version-indicator><date>20060101</date></ipc-version-indicator>
<classification-level>A</classification-level>
<section>G</section>
<class>06</class>
<subclass>K</subclass>
<main-group>9</main-group>
<subgroup>32</subgroup>
<symbol-position>L</symbol-position>
<classification-value>I</classification-value>
<action-date><date>20071120</date></action-date>
<generating-office><country>US</country></generating-office>
<classification-status>B</classification-status>
<classification-data-source>H</classification-data-source>
</classification-ipcr>
<classification-ipcr>
<ipc-version-indicator><date>20060101</date></ipc-version-indicator>
<classification-level>A</classification-level>
<section>G</section>
<class>06</class>
<subclass>K</subclass>
<main-group>9</main-group>
<subgroup>28</subgroup>
<symbol-position>L</symbol-position>
<classification-value>N</classification-value>
<action-date><date>20071120</date></action-date>
<generating-office><country>US</country></generating-office>
<classification-status>B</classification-status>
<classification-data-source>H</classification-data-source>
</classification-ipcr>
</classifications-ipcr>
<classification-national>
<country>US</country>
<main-classification>382254</main-classification>
<further-classification>382299</further-classification>
</classification-national>
<invention-title id="d0e89">Image processing program product and device for executing Retinex processing</invention-title>
<references-cited>
<citation>
<patcit num="00001">
<document-id>
<country>US</country>
<doc-number>4384336</doc-number>
<kind>A</kind>
<name>Frankle et al.</name>
<date>19830500</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00002">
<document-id>
<country>US</country>
<doc-number>5991456</doc-number>
<kind>A</kind>
<name>Rahman et al.</name>
<date>19991100</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00003">
<document-id>
<country>US</country>
<doc-number>6882449</doc-number>
<kind>B2</kind>
<name>Kimmel et al.</name>
<date>20050400</date>
</document-id>
</patcit>
<category>cited by examiner</category>
<classification-national><country>US</country><main-classification>358  19</main-classification></classification-national>
</citation>
<citation>
<patcit num="00004">
<document-id>
<country>US</country>
<doc-number>2002/0196350</doc-number>
<kind>A1</kind>
<name>Cooper</name>
<date>20021200</date>
</document-id>
</patcit>
<category>cited by examiner</category>
<classification-national><country>US</country><main-classification>3482231</main-classification></classification-national>
</citation>
<citation>
<patcit num="00005">
<document-id>
<country>JP</country>
<doc-number>11-249004</doc-number>
<date>19990900</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00006">
<document-id>
<country>JP</country>
<doc-number>2001-076122</doc-number>
<date>20010300</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00007">
<document-id>
<country>JP</country>
<doc-number>P2001-69525</doc-number>
<kind>A</kind>
<date>20010300</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00008">
<document-id>
<country>JP</country>
<doc-number>P2001-78025</doc-number>
<kind>A</kind>
<date>20010300</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00009">
<document-id>
<country>JP</country>
<doc-number>P2001-245154</doc-number>
<kind>A</kind>
<date>20010900</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00010">
<document-id>
<country>JP</country>
<doc-number>2001-285889</doc-number>
<date>20011000</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00011">
<document-id>
<country>JP</country>
<doc-number>P2001-313844</doc-number>
<kind>A</kind>
<date>20011100</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00012">
<document-id>
<country>JP</country>
<doc-number>2002-074356</doc-number>
<kind>A</kind>
<date>20020300</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00013">
<document-id>
<country>JP</country>
<doc-number>2005-515515</doc-number>
<kind>A</kind>
<date>20050500</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<patcit num="00014">
<document-id>
<country>WO</country>
<doc-number>WO 02/089062</doc-number>
<kind>A2</kind>
<date>20021100</date>
</document-id>
</patcit>
<category>cited by other</category>
</citation>
<citation>
<nplcit num="00015">
<othercit>Jobson, Daniel, J., et al. “A Multiscale Retinex for Bridging the Gap Between Color Images and Human Observation of Scenes.” IEEE Transactions on Image Processing, Jul. 1997, vol. 6, No. 7, pp. 965-976.</othercit>
</nplcit>
<category>cited by other</category>
</citation>
<citation>
<nplcit num="00016">
<othercit>“Improvement of Image Appearance by Modified Retinex Model”, Masaaki Kobayashi and Hiroaki Kotera,transactions of Color Forum Japan 2001 (47th optical four institutions joint meeting, Nov. 13-15, 2001).</othercit>
</nplcit>
<category>cited by other</category>
</citation>
</references-cited>
<number-of-claims>15</number-of-claims>
<us-exemplary-claim>1</us-exemplary-claim>
<us-field-of-classification-search>
<classification-national>
<country>US</country>
<main-classification>382254</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382260</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382264</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382275</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382318</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382324</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382162</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382167</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382299</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382300</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382298</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>382312</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>348254</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>3482231</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>3482316</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>358518</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>358519</main-classification>
</classification-national>
<classification-national>
<country>US</country>
<main-classification>358525</main-classification>
</classification-national>
</us-field-of-classification-search>
<figures>
<number-of-drawing-sheets>17</number-of-drawing-sheets>
<number-of-figures>19</number-of-figures>
</figures>
<us-related-documents>
<related-publication>
<document-id>
<country>US</country>
<doc-number>20040091164</doc-number>
<kind>A1</kind>
<date>20040513</date>
</document-id>
</related-publication>
</us-related-documents>
<parties>
<applicants>
<applicant sequence="001" app-type="applicant-inventor" designation="us-only">
<addressbook>
<last-name>Sakatani</last-name>
<first-name>Kazuomi</first-name>
<address>
<city>Toyokawa</city>
<country>JP</country>
</address>
</addressbook>
<nationality>
<country>JP</country>
</nationality>
<residence>
<country>JP</country>
</residence>
</applicant>
<applicant sequence="002" app-type="applicant-inventor" designation="us-only">
<addressbook>
<last-name>Itoh</last-name>
<first-name>Tetsuya</first-name>
<address>
<city>Okazaki</city>
<country>JP</country>
</address>
</addressbook>
<nationality>
<country>JP</country>
</nationality>
<residence>
<country>JP</country>
</residence>
</applicant>
<applicant sequence="003" app-type="applicant-inventor" designation="us-only">
<addressbook>
<last-name>Miyake</last-name>
<first-name>Yoichi</first-name>
<address>
<city>Sakura</city>
<country>JP</country>
</address>
</addressbook>
<nationality>
<country>JP</country>
</nationality>
<residence>
<country>JP</country>
</residence>
</applicant>
<applicant sequence="004" app-type="applicant-inventor" designation="us-only">
<addressbook>
<last-name>Tsumura</last-name>
<first-name>Norimichi</first-name>
<address>
<city>Chiba</city>
<country>JP</country>
</address>
</addressbook>
<nationality>
<country>JP</country>
</nationality>
<residence>
<country>JP</country>
</residence>
</applicant>
</applicants>
<agents>
<agent sequence="01" rep-type="attorney">
<addressbook>
<orgname>McDermott Will &amp; Emery LLP</orgname>
<address>
<country>unknown</country>
</address>
</addressbook>
</agent>
</agents>
</parties>
<assignees>
<assignee>
<addressbook>
<orgname>Minolta Co., Ltd.</orgname>
<role>03</role>
<address>
<city>Osaka</city>
<country>JP</country>
</address>
</addressbook>
</assignee>
</assignees>
<examiners>
<primary-examiner>
<last-name>Couso</last-name>
<first-name>Yon J.</first-name>
<department>2624</department>
</primary-examiner>
</examiners>
</us-bibliographic-data-grant>
<abstract id="abstract">
<p id="p-0001" num="0000">An image not subjected to color correction, gamma correction, MTF correction and others is used as an image to be subjected to Retinex image processing. Thus, a RAW image prepared only by converting an electric signal of a CCD image sensor by an A/D converter into a digital form is used as an image to be subjected to the Retinex processing. Predetermined gamma correction is performed after the Retinex processing. Thereby, Retinex algorithm substantially modeling functions of a retina and a cortex of a living body exhibits its original performance. The resolution of the original image is lowered, and processing is performed on an image thus produced to produce a blurred image. Then, the resolution of the blurred image is restored to the same resolution as that of the original image, and the Retinex processing is performed. Thereby, the Retinex processing can be performed without increasing memory consumption and extremely lowering an operation speed.</p>
</abstract>
<drawings id="DRAWINGS">
<figure id="Fig-EMI-D00000" num="00000">
<img id="EMI-D00000" he="199.47mm" wi="176.61mm" file="US07298917-20071120-D00000.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00001" num="00001">
<img id="EMI-D00001" he="231.14mm" wi="72.98mm" orientation="landscape" file="US07298917-20071120-D00001.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00002" num="00002">
<img id="EMI-D00002" he="201.17mm" wi="62.15mm" orientation="landscape" file="US07298917-20071120-D00002.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00003" num="00003">
<img id="EMI-D00003" he="249.60mm" wi="66.55mm" orientation="landscape" file="US07298917-20071120-D00003.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00004" num="00004">
<img id="EMI-D00004" he="268.65mm" wi="146.81mm" orientation="landscape" file="US07298917-20071120-D00004.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00005" num="00005">
<img id="EMI-D00005" he="110.83mm" wi="145.88mm" file="US07298917-20071120-D00005.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00006" num="00006">
<img id="EMI-D00006" he="244.52mm" wi="176.70mm" file="US07298917-20071120-D00006.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00007" num="00007">
<img id="EMI-D00007" he="212.68mm" wi="178.90mm" file="US07298917-20071120-D00007.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00008" num="00008">
<img id="EMI-D00008" he="192.02mm" wi="171.79mm" file="US07298917-20071120-D00008.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00009" num="00009">
<img id="EMI-D00009" he="198.29mm" wi="125.98mm" file="US07298917-20071120-D00009.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00010" num="00010">
<img id="EMI-D00010" he="96.35mm" wi="112.86mm" file="US07298917-20071120-D00010.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00011" num="00011">
<img id="EMI-D00011" he="259.33mm" wi="127.93mm" orientation="landscape" file="US07298917-20071120-D00011.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00012" num="00012">
<img id="EMI-D00012" he="232.92mm" wi="168.91mm" file="US07298917-20071120-D00012.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00013" num="00013">
<img id="EMI-D00013" he="220.13mm" wi="178.39mm" file="US07298917-20071120-D00013.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00014" num="00014">
<img id="EMI-D00014" he="272.37mm" wi="144.19mm" orientation="landscape" file="US07298917-20071120-D00014.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00015" num="00015">
<img id="EMI-D00015" he="210.31mm" wi="101.01mm" file="US07298917-20071120-D00015.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00016" num="00016">
<img id="EMI-D00016" he="221.66mm" wi="155.62mm" orientation="landscape" file="US07298917-20071120-D00016.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
<figure id="Fig-EMI-D00017" num="00017">
<img id="EMI-D00017" he="213.53mm" wi="153.16mm" orientation="landscape" file="US07298917-20071120-D00017.TIF" alt="embedded image" img-content="drawing" img-format="tif"/>
</figure>
</drawings>
<description id="description">
<?BRFSUM description="Brief Summary" end="lead"?>
<p id="p-0002" num="0001">This application is based on Japanese Patent Application Nos. 2002-327290 and 2002-327291, the entire content of which is hereby incorporated by reference.</p>
<heading id="h-0001" level="1">BACKGROUND OF THE INVENTION</heading>
<p id="p-0003" num="0002">1. Field of the Invention</p>
<p id="p-0004" num="0003">The present invention relates to an image processing program product and an image processing apparatus, and particularly to an image processing program product and an apparatus for performing Retinex processing as a part of processing effected on output images of digital cameras and film scanners.</p>
<p id="p-0005" num="0004">2. Description of the Related Art</p>
<p id="p-0006" num="0005">In a conventional field of image processing, a Center/Surround Retinex processing has been proposed as an image processing technology, in which functions of a retina and a cortex of a living body are substantially modeled (e.g., U.S. Pat. No. 5,991,456).</p>
<p id="p-0007" num="0006">The Retinex processing is a method for correcting image information forming digital data. There are various modifications of the Retinex processing. In this specification, however, correction methods, in which the visual sensation is modeled and surrounding information with respect to a center pixel (i.e., pixel of interest) is taken into consideration, are collectively referred to as “Retinex processing”. Expanded Retinex to be described later is one of forms included in the Retinex processing. According to the Retinex processing, since gain adjustment locally changes in accordance with light and darkness in the image, an effect of compressing a dynamic range can be achieved.</p>
<p id="p-0008" num="0007">In connection with Center/Surround Retinex algorithm, Single Scale Retinex (SSR) and Multi-Scale Retinex (MSR) have been known. Algorithm of the SSR and MSR will now be described.</p>
<p id="p-0009" num="0008">The Single Scale Retinex (SSR) is expressed by the following formula (1). The processing in formula (1) is executed on each of R, G and B channels, and results are integrated to provide a color output image.
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?><i>T</i><sub>i</sub>(<i>x, y</i>)=log <i>I</i><sub>i</sub>(<i>x, y</i>)−log{<i>F</i>(<i>x, y</i>)*<i>I</i><sub>i</sub>(<i>x, y</i>)}  (1)<?in-line-formulae description="In-line Formulae" end="tail"?>
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?>(i=R, G, B)<?in-line-formulae description="In-line Formulae" end="tail"?>
<br/>
where “*” represents a convolution integral. T<sub>i</sub>(x, y) represents a pixel value after the SSR processing, and I<sub>i</sub>(x, y) represents a pixel value of an original image. F(x, y) is a function used in a filter for producing a blurred image in view of pixels surrounding the center pixel. For example, F(x, y) may be a Gaussian function, in which case F(x, y) satisfies the following relationships (2) and (3).
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?><i>F</i>(<i>x, y</i>)=<i>K</i>·exp{−(<i>x</i><sup>2</sup><i>+y</i><sup>2</sup>)<i>/c</i><sup>2</sup>}  (2)<?in-line-formulae description="In-line Formulae" end="tail"?>
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?>ΣΣ<i>F</i>(<i>x, y</i>)=1  (3)<?in-line-formulae description="In-line Formulae" end="tail"?>
<br/>
where c represents a constant determining a peripheral spread in the Gaussian function, and is referred to as a kernel value. The constant K is determined to satisfy the formula (3). It is generally known that a smaller value of c increases an effect of edge enhancement in image processing, and a larger value of c increases an effect of dynamic range compression.
</p>
<p id="p-0010" num="0009">Clipping processing is performed for the purpose of improving a contrast in the output image subjected to the SSR processing. Usually, pixel values within lower and higher 3% ranges in a histogram distribution are clipped, and then are subjected to linear transformation to be assigned to digital values corresponding to the number of output bits (e.g., 8 bits).</p>
<p id="p-0011" num="0010"><figref idref="DRAWINGS">FIG. 18</figref> illustrates specific processing of SSR using the Gaussian function for producing a blurred image.</p>
<p id="p-0012" num="0011">Referring to <figref idref="DRAWINGS">FIG. 18</figref>, processing is effected on an original image (processing target image) D<b>2</b> having i=R, G and B. In <figref idref="DRAWINGS">FIG. 18</figref>, P<b>2</b> indicates an image produced by combining R, G and B in the original image.</p>
<p id="p-0013" num="0012">Each pixel value in D<b>2</b> is represented as I<sub>i</sub>(x, y). For producing a blurred image D<b>4</b>, an operation of I<sub>i</sub>(x, y)*G(x, y) is performed. G(x, y) is a Gaussian function.</p>
<p id="p-0014" num="0013">Processing is performed to divide each pixel value of the original image by the pixel value of the blurred image, and a logarithm of the result is obtained so that an image D<b>5</b> subjected to the Retinex processing is obtained. Each pixel value of image D<b>5</b> is represented by Ri(x, y). By combining images D<b>5</b> formed of R, G and B, image P<b>1</b> subjected to the Retinex processing is obtained.</p>
<p id="p-0015" num="0014">According to the Multi-Scale Retinex (MSR), various different values are used as constant c in formula (2). Thereby, the SSR processing is performed with the Gaussian functions having different peripheral spreads. The respective results thus obtained are summed and averaged so that the edge enhancement and dynamic range compression are simultaneously achieved.</p>
<p id="p-0016" num="0015"><figref idref="DRAWINGS">FIG. 19</figref> illustrates the MSR processing using the Gaussian function.</p>
<p id="p-0017" num="0016">Referring to <figref idref="DRAWINGS">FIG. 19</figref>, blurred images D<b>4</b>-<b>1</b>, D<b>4</b>-<b>2</b> and D<b>4</b>-<b>3</b> are produced based on original image D<b>2</b>, and more specifically are produced with a Gaussian function having a narrow peripheral spread (a filter of a small size), a Gaussian function having a medium peripheral spread (a filter of a medium size) and a Gaussian function having a wide peripheral spread (a filter of a large size), respectively.</p>
<p id="p-0018" num="0017">Original image D<b>2</b> is divided by the respective blurred images, and logarithms of the results are obtained to provide images D<b>5</b>-<b>1</b>-D<b>5</b>-<b>3</b>. A higher effect of edge enhancement is achieved in the image processed with a function of a small filter size, and a higher effect of dynamic range compression is achieved in the image processed with a function of a large filter size. By summing and averaging images D<b>5</b>-<b>1</b>-D<b>5</b>-<b>3</b>, the edge enhancement and dynamic range compression can be simultaneously achieved.</p>
<p id="p-0019" num="0018">Study and research have been zealously conducted for applying the foregoing SSR and MSR processing to image data, which is produced in a digital form from negative films or the like by film scanners, and digital image data produced by digital still cameras.</p>
<p id="p-0020" num="0019">Japanese Patent Laying-Open No. 2001-245154 discloses a technique, in which a large contrast difference between different regions in an image is reduced while maintaining a small contrast difference between different regions in the image.</p>
<p id="p-0021" num="0020">“Improvement of Image Appearance by Modified Retinex Model”, Masaki Kobayashi and Hiroaki Kotera, transactions of Color Forum JAPAN 2001 (47th optical four institutions joint meeting, Nov. 13-15, 2001) discloses a technique, in which the Retinex processing is formed of linear operations.</p>
<p id="p-0022" num="0021">The image processing techniques such as a conventional Center/Surround Retinex algorithm already described suffer from problems of:
<ul id="ul0001" list-style="none">
    <li id="ul0001-0001" num="0022">shift of a whole tint in an image using colors shifted to a large extent, and</li>
    <li id="ul0001-0002" num="0023">unnatural saturation of luminance in a bright region such as a face.</li>
</ul>
</p>
<p id="p-0023" num="0024">For overcoming the above problems, expanded Retinex processing techniques such as:
<ul id="ul0002" list-style="none">
    <li id="ul0002-0001" num="0025">a manner in which information of the original image is added to an output image to a certain extent,</li>
    <li id="ul0002-0002" num="0026">a manner in which Retinex processing is effected on only luminance information, and</li>
    <li id="ul0002-0003" num="0027">a manner in which portions of certain luminance or higher in a blurred image already subjected to filtering with a Gaussian function is rounded,</li>
    <li id="ul0002-0004" num="0028">have been proposed for suppressing the extreme shift of the tint and the unnatural luminance saturation in bright regions have been proposed.</li>
</ul>
</p>
<p id="p-0024" num="0029">According to the image processing techniques such as a conventional Center/Surround Retinex algorithm already described, calculation processing for producing a blurred image becomes heavy particularly when an original image has a high resolution. This results in problems of increase of memory consumption and lowering of processing speed.</p>
<heading id="h-0002" level="1">SUMMARY OF THE INVENTION</heading>
<p id="p-0025" num="0030">A first object of the invention is to provide a new image processing program product, which can exhibit original characteristics of the Retinex image processing technique modeling functions of a retina and a cortex of a living body without depending on contents of a target image.</p>
<p id="p-0026" num="0031">A second object of the invention is to provide an image processing program product, which can perform Retinex processing without causing increase of memory consumption and extreme lowering of a processing speed.</p>
<p id="p-0027" num="0032">For achieving the above objects, an image processing program product for executing Retinex processing by a computer according to an aspect of the invention uses a RAW image as an original image to be processed.</p>
<p id="p-0028" num="0033">According to the invention, since the RAW image is used as the target of the Retinex processing, original characteristics of the Retinex processing can be achieved.</p>
<p id="p-0029" num="0034">According to another aspect of the invention, an image processing program product for executing Retinex processing by a computer is configured to execute, by the computer, a first step of producing an image by lowering a resolution of an original image to be processed, a second step of producing a blurred image from the image produced by lowering the resolution of the original image, a third step of restoring the resolution of the blurred image to that of the original image, and a fourth step of executing the Retinex processing based on the original image and the blurred image having the resolution restored to the resolution of the original image.</p>
<p id="p-0030" num="0035">According to this invention, the image is produced by lowering the resolution of the original image to be processed, and the blurred image is produced from the image produced by lowering the resolution of the original image. Therefore, the invention can provide the image processing program, which can perform the Retinex processing without causing increase of the memory consumption and extreme lowering of the operation speed.</p>
<p id="p-0031" num="0036">According to still another aspect of the invention, an image processing program product of producing a blurred image with a degree of blur corresponding to a resolution of an original image and using Retinex processing is configured to execute, by a computer, a first step of producing an image by converting the resolution of the original image to a predetermined resolution, and a second step of producing the blurred image from the produced image.</p>
<p id="p-0032" num="0037">According to yet another aspect of the invention, an image processing program product for executing Multi-Scale Retinex processing by a computer is configured to execute, by the computer, a first step of producing a plurality of images by lowering a resolution of an original image to be processed to multiple levels, a second step of producing a blurred image of each of the plurality of images by using a predetermined filter, a third step of restoring the resolutions of the plurality of produced blurred images to the resolution of the original image, and a fourth step of executing Multi-Scale Retinex processing based on the original image and the plurality of blurred images having the resolutions restored to the resolution of the original image.</p>
<p id="p-0033" num="0038">According to the invention, the plurality of images are produced by lowering the resolution of the original image to be processed to the multiple levels, the blurred image of each of the plurality of images is produced by using the predetermined filter, and the Multi-Scale Retinex processing is executed based on the blurred images thus produced. Thereby, the invention can provide the image processing program, which can perform the Multi-Scale Retinex processing without causing increase of the memory consumption and extreme lowering of the operation speed.</p>
<p id="p-0034" num="0039">According to further another aspect of the invention, an image processing program product for executing Multi-Scale Retinex processing by a computer is configured to execute, by the computer, a first step of preparing a plurality of images including an original image by producing at least one image of a lower resolution from the original image to be processed, a second step of producing blurred images from at least two of the plurality of images by using a predetermined filter, a third step of restoring the resolution of each of the at least two blurred images to the resolution of the original image if the at least two blurred images have the resolutions different from the resolution of the original image, and a fourth step of executing the Multi-Scale Retinex processing based on the original image and the at least two blurred images having the resolution of the original image.</p>
<p id="p-0035" num="0040">According to this structure, it is not necessary to prepare filters of a plurality of sizes for performing the Multi-Scale Retinex processing so that the program itself can be small in capacity, and can be simple. In the case where the blurred image is not produced from the original image, but is produced from each of a plurality of images of low resolutions prepared by lowering the resolution to different levels, respectively, the invention can provide the image processing program, which can perform the Multi-Scale Retinex processing without causing increase of the memory consumption and extreme lowering of the operation speed.</p>
<p id="p-0036" num="0041">According to still further another aspect of the invention, an image processing program product for executing Retinex processing based on a blurred image by a computer is characterized in that the blurred image is produced in an optical manner.</p>
<p id="p-0037" num="0042">According to a further aspect of the invention, an image pickup apparatus for executing Retinex processing includes an image pickup device for shooting an original image to be processed, producing portion for optically producing a blurred image of the original image, and executing portion for executing the Retinex processing based on the original image and the blurred image.</p>
<p id="p-0038" num="0043">According to the above structure, since the blurred image is produced optically, it is possible to provide an image processing program and an apparatus for the same, which do not require complicated calculation.</p>
<?BRFSUM description="Brief Summary" end="tail"?>
<?brief-description-of-drawings description="Brief Description of Drawings" end="lead"?>
<description-of-drawings>
<p id="p-0039" num="0044">The foregoing and other objects, features, aspects and advantages of the present invention will become more apparent from the following detailed description of the present invention when taken in conjunction with the accompanying drawings.</p>
<heading id="h-0003" level="1">BRIEF DESCRIPTION OF THE DRAWINGS</heading>
<p id="p-0040" num="0045"><figref idref="DRAWINGS">FIG. 1</figref> is a block diagram showing a structure of an image pickup apparatus performing Retinex processing in a first embodiment.</p>
<p id="p-0041" num="0046"><figref idref="DRAWINGS">FIG. 2</figref> is a block diagram showing a structure of an image pickup apparatus performing Retinex processing in a second embodiment.</p>
<p id="p-0042" num="0047"><figref idref="DRAWINGS">FIG. 3</figref> is a block diagram showing a structure of an image pickup apparatus performing Retinex processing in a third embodiment.</p>
<p id="p-0043" num="0048"><figref idref="DRAWINGS">FIG. 4</figref> is a block diagram showing a structure of a digital camera in a fourth embodiment.</p>
<p id="p-0044" num="0049"><figref idref="DRAWINGS">FIG. 5</figref> is a block diagram showing a structure of a computer executing a program in a fifth embodiment.</p>
<p id="p-0045" num="0050"><figref idref="DRAWINGS">FIG. 6</figref> is a flowchart illustrating Retinex processing executed by the computer in <figref idref="DRAWINGS">FIG. 5</figref>.</p>
<p id="p-0046" num="0051"><figref idref="DRAWINGS">FIG. 7</figref> is a flowchart illustrating linear Retinex processing executed by the computer in <figref idref="DRAWINGS">FIG. 5</figref>.</p>
<p id="p-0047" num="0052"><figref idref="DRAWINGS">FIG. 8</figref> shows a structure of a Retinex processing portion in an image processing apparatus of a sixth embodiment.</p>
<p id="p-0048" num="0053"><figref idref="DRAWINGS">FIG. 9</figref> is a graph illustrating spread of a Gaussian function applied to a low-resolution image in a one-dimensional manner along an X-axis.</p>
<p id="p-0049" num="0054"><figref idref="DRAWINGS">FIG. 10</figref> is a graph illustrating spread of a Gaussian function applied to a high-resolution image in a one-dimensional manner along an X-axis.</p>
<p id="p-0050" num="0055"><figref idref="DRAWINGS">FIG. 11</figref> illustrates calculation formulas for kernel values corresponding to respective resolutions.</p>
<p id="p-0051" num="0056"><figref idref="DRAWINGS">FIG. 12</figref> illustrates peripheral spread of different four functions in a one-dimensional manner.</p>
<p id="p-0052" num="0057"><figref idref="DRAWINGS">FIG. 13</figref> illustrates processing performed by an interpolating portion <b>401</b>, a blurred image producing portion <b>403</b> and an interpolating portion <b>405</b> in an eighth embodiment.</p>
<p id="p-0053" num="0058"><figref idref="DRAWINGS">FIG. 14</figref> is a flowchart illustrating Retinex processing in a ninth embodiment.</p>
<p id="p-0054" num="0059"><figref idref="DRAWINGS">FIG. 15</figref> is a flowchart illustrating a case of changing a resolution of an original image before producing a blurred image, and setting a c-value in the linear Retinex processing illustrated in <figref idref="DRAWINGS">FIG. 7</figref>.</p>
<p id="p-0055" num="0060"><figref idref="DRAWINGS">FIG. 16</figref> is a block diagram showing a structure of a digital camera in a tenth embodiment.</p>
<p id="p-0056" num="0061"><figref idref="DRAWINGS">FIG. 17</figref> is a flowchart illustrating image pickup processing of a digital camera in an eleventh embodiment.</p>
<p id="p-0057" num="0062"><figref idref="DRAWINGS">FIG. 18</figref> illustrates specific SSR processing with a Gaussian function for producing a blurred image.</p>
<p id="p-0058" num="0063"><figref idref="DRAWINGS">FIG. 19</figref> illustrates MSR processing with a Gaussian function.</p>
</description-of-drawings>
<?brief-description-of-drawings description="Brief Description of Drawings" end="tail"?>
<?DETDESC description="Detailed Description" end="lead"?>
<heading id="h-0004" level="1">DESCRIPTION OF THE PREFERRED EMBODIMENTS</heading>
<p id="p-0059" num="0064">In image processing methods, image processing programs, image processing apparatuses and others disclosed as embodiments of the invention, target images to be subjected to Retinex processing are formed of RAW images directly prepared by A/D conversion of analog signals provided from an image pickup device such as a CCD image sensor or a CMOS image sensor. After the Retinex processing, predetermined gamma correction is performed. In sixth and higher embodiments, the target image may be an image already subjected to the gamma correction. The image “directly prepared by the A/D conversion” means the image not subjected at least to the gamma correction, and preferably means the image not subjected to color correction and MTF correction. Even if the images are already subjected to correction for hardware adjustment required due to variations in sensitivity of elements of image pickup apparatuses and/or tint conversion such as gamut, these images can be deemed as the RAW images in the invention. For example, if the image pickup apparatus is an area-type sensor having color filters, processing for pixel interpolation is performed on image data of each color after the A/D conversion. The image data subjected to such interpolation processing can also be deemed as the RAW image.</p>
<p id="p-0060" num="0065">Thereby, the Retinex processing, which substantially models functions of a retina and a cortex of a living body, can exhibit its original characteristics.</p>
<p id="p-0061" num="0066">More specifically, digital image data provided from conventional film scanners and digital still cameras are already subjected to color correction of so-called white balance or the like, gamma correction, MTF correction and others. In the prior art, the Retinex processing and the expanded Retinex processing are performed on digital image data (i.e., target data), which are already subjected to such kinds of image processing. The conventional Retinex processing is effected on the image data, which is already subjected to the several kinds of image processing, for the purpose of improving qualities such as contrast and appearance.</p>
<p id="p-0062" num="0067">However, the Retinex model is originally aimed at substantially modeling functions of a retina and a cortex of a living body. For sufficiently exhibiting its characteristics, the Retinex model should be applied to raw sensor responses. Conversely, it may be considered as follows. The Retinex processing in the prior art is executed on the image data already subjected to conventional image processing such as color correction, gamma correction and MTF correction, and this may cause conventional disadvantages such as a shift of entire tint in an image, which has many color-shifted regions, and an entire tendency of spitting in a bright region such as a face. Consequently, more complicated processing, i.e., expanded Retinex processing is required for suppressing the above disadvantages.</p>
<p id="p-0063" num="0068">In view of the above, the embodiments are configured to perform the Retinex processing such as SSR and MSR on raw digital image data, which are subjected only to the A-D conversion of electric signals of the image pickup apparatus such as a CCD image sensor (and is not yet subjected to the gamma correction and others), whereby the Retinex model can exhibit its original effects.</p>
<p id="p-0064" num="0069">Embodiments of the invention will now be described with reference to the drawings.</p>
<heading id="h-0005" level="1">First Embodiment</heading>
<p id="p-0065" num="0070"><figref idref="DRAWINGS">FIG. 1</figref> is a block diagram showing a structure of an image pickup apparatus performing Retinex processing in a first embodiment. In <figref idref="DRAWINGS">FIG. 1</figref>, arrows indicate flows of image data.</p>
<p id="p-0066" num="0071">Referring to <figref idref="DRAWINGS">FIG. 1</figref>, an image pickup apparatus includes a CCD image sensor <b>101</b> serving as an image pickup device, an A/D converter <b>102</b>, a Retinex processing portion <b>103</b>, a gamma correcting portion <b>104</b> and a display/save portion <b>105</b>.</p>
<p id="p-0067" num="0072">CCD image sensor <b>101</b> produces analog signals R, G and B (i.e., electric signals) from incident light by a photoelectric conversion. A/D converter <b>102</b> converts analog signals R, G and B into discrete digital signals R, G and B, e.g., of eight bits. Retinex processing portion <b>103</b> conducts the Retinex processing such as SSR or MSR on digital image signals, which are subjected only to the A/D conversion by A/D converter <b>102</b>, and particularly on each of R, G and B channels independently of each other.</p>
<p id="p-0068" num="0073">Gamma correcting portion <b>104</b> performs predetermined gamma correction, which is required in a later display/save step, on the Retinex output obtained by Retinex processing portion <b>103</b>.</p>
<p id="p-0069" num="0074">Finally, the display/save portion <b>105</b> displays the image data, which is subjected to the predetermined gamma processing by gamma correcting portion <b>104</b>, on a monitor or save it on a hard disk.</p>
<p id="p-0070" num="0075">The structure shown in <figref idref="DRAWINGS">FIG. 1</figref> can be achieved by hardware within a digital still camera. However, if a digital camera, which can provide image data subjected to only A/D conversion as RAW images, is used, the foregoing Retinex processing, gamma correction processing and other image processing can be executed in a software manner on the image data temporarily saved in the RAW format by using an application installed in a personal computer or the like.</p>
<p id="p-0071" num="0076">Since the Retinex processing expressed by the foregoing formula (1) includes a convolution integral, the processing speed significantly depends on a size of a filter, e.g., of a Gaussian function expressed by F(x, y) and an image size itself. In general, Retinex processing uses a filter of a very large size, and a filter of a size of kernel value c equal to about 100 is often used even for images of a relatively low resolution (e.g., VGA of 640×480 pixels). In this case, it takes several hours to complete the processing even by a recent personal computer capable of high-speed operation. This is not practically accepted.</p>
<p id="p-0072" num="0077">For fast execution of the convolution integral, it has been known to use Fourier transform, which is a manner of executing calculation in a frequency range. To discrete signals such as a digital image, fast processing manners such as FFT (Fast Fourier Transforms) or DFT (Discrete Fast Fourier Transforms) can be applied. The convolution integral of the foregoing formula (1) can be expressed in the following formula (4) when an image has a size of a power of 2.
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?><i>F</i>(<i>x, y</i>)<i>*I</i><sub>i</sub>(<i>x, y</i>)=FFT<sup>−1</sup>[FFT[<i>F</i>(<i>x, y</i>)]·FFT[<i>I</i><sub>i</sub>(<i>x, y</i>)]]  (4)<?in-line-formulae description="In-line Formulae" end="tail"?>
<br/>
where FFT<sup>−1 </sup>represents an inverse FFT, and “·” represents multiplication in a frequency region. In this case, the processing speed is independent of the filter size of the Gaussian function expressed by F(x, y), and depends on the image size itself. If the image size is not equal to a power of 2, FFT can be replaced with DFT.
</p>
<p id="p-0073" num="0078">According to the present embodiment, as described above, the Retinex processing is applied to the RAW image subjected to only the A/D conversion, and predetermined gamma correction is performed after the Retinex processing, whereby the Retinex processing can exhibit the original function of substantially modeling the functions of the retina and cortex of the living body.</p>
<p id="p-0074" num="0079">The RAW image basically represents data prepared by performing only the A/D conversion on the output of CCD. However, the images may be already subjected to correction for hardware adjustment required due to variations in sensitivity of the CCD elements and/or tint conversion such as gamut, and these images may be regarded as the RAW images. For example, if the image pickup apparatus is an area-type sensor having color filters, processing for pixel interpolation is performed on image data of each color after the A/D conversion. The image data subjected to the interpolation processing can be deemed as the RAW image.</p>
<p id="p-0075" num="0080">In the invention, the image data at least before the gamma correction is referred to as the RAW image, and it is further desirable that the RAW image is not yet subjected to sharpness balance correction and white balance correction.</p>
<heading id="h-0006" level="1">Second Embodiment</heading>
<p id="p-0076" num="0081"><figref idref="DRAWINGS">FIG. 2</figref> is a block diagram showing a structure of an image pickup apparatus performing Retinex processing in a second embodiment.</p>
<p id="p-0077" num="0082">In this embodiment, Retinex processing portion <b>103</b> performs linear Retinex processing. The linear Retinex processing is Retinex processing not using a logarithm, and is executed with a ratio between an original image and a blurred image expressed by the following formula (5).
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?><i>T</i><sub>i</sub>(<i>x, y</i>)=<i>I</i><sub>i</sub>(<i>x, y</i>)<i>/{F</i>(<i>x, y</i>)<i>*I</i><sub>i</sub>(<i>x, y</i>)}  (5)<?in-line-formulae description="In-line Formulae" end="tail"?>
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?>(i=R, G,B)<?in-line-formulae description="In-line Formulae" end="tail"?>
<br/>
where “*” represents a convolution integral, similarly to the formula (1). T<sub>i</sub>(x, y) represents a pixel value after the linear Retinex processing, and I<sub>i</sub>(x, y) represents a pixel value of an original image. F(x, y) is, e.g., a Gaussian function for producing a blurred image satisfying the foregoing formulas (2) and (3).
</p>
<p id="p-0078" num="0083">The linear Retinex processing may be likewise executed by MSR.</p>
<p id="p-0079" num="0084">Further, Retinex processing portion <b>103</b> may perform the processing (gamma correction) of obtaining a (1/γ)th power T<sub>i</sub>(x, y), as expressed by the following formula (6):
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?>γ{<i>T</i><sub>i</sub>(<i>x, y</i>)}=<i>T</i><sub>i</sub>(<i>x, y</i>)^(1/γ)   (6)<?in-line-formulae description="In-line Formulae" end="tail"?>
</p>
<p id="p-0080" num="0085">For displaying an image on a monitor, e.g., set for sRGB, the assumed gamma is equal to 2.2, and the gamma correction is achieved by multiplying T<sub>i</sub>(x, y) by the inverse ( 1/2.2) thereof Naturally, such a structure may be employed that the value of gamma is variably adjusted in accordance with a device for display or printing.</p>
<p id="p-0081" num="0086">Further, it is not necessary to match forcedly the gamma characteristics of the data provided by the Retinex processing with the gamma of a specific monitor or the like. For example, if it is desired to provide characteristics, which are linear with respect to the brightness, the (⅓)th power of linear Retinex is obtained (γ is set to 3).</p>
<p id="p-0082" num="0087">The gamma-corrected image of the Retinex output obtained by the formula (6) may be processed by clipping the pixel values in upper and lower 3% ranges of the histogram distribution as described above for the purpose of improving the contrast of the image. Naturally, the Retinex output obtained by linear Retinex processing portion <b>103</b> can be subjected to the gamma correction after the above clipping processing.</p>
<heading id="h-0007" level="1">Third Embodiment</heading>
<p id="p-0083" num="0088"><figref idref="DRAWINGS">FIG. 3</figref> is a block diagram showing a structure of an image pickup apparatus performing the Retinex processing in a third embodiment.</p>
<p id="p-0084" num="0089">In this embodiment, Retinex processing portion <b>103</b> shown in <figref idref="DRAWINGS">FIG. 2</figref> performs the linear Retinex processing, and then gamma correcting portion <b>104</b> performs the gamma correction for the device. Thereby, the gamma correction can be performed in accordance with the device. Thus, the gamma correction can be performed only by gamma correcting portion <b>104</b>. Alternatively, processing may be performed in such a manner that Retinex processing portion <b>103</b> performs the gamma correction with γ=3 for providing the output having linear characteristics with respect to the brightness as described above, and gamma correcting portion <b>104</b> performs the correction in accordance with the device.</p>
<heading id="h-0008" level="1">Fourth Embodiment</heading>
<p id="p-0085" num="0090"><figref idref="DRAWINGS">FIG. 4</figref> is a bock diagram showing a structure of a digital camera in a fourth embodiment of the invention.</p>
<p id="p-0086" num="0091">Referring to <figref idref="DRAWINGS">FIG. 4</figref>, the digital camera includes a lens L, a lens control portion <b>209</b> for driving lens L, a CCD image sensor <b>201</b>, an A/D converter <b>203</b> for performing the A/D conversion of the output of CCD image sensor <b>201</b>, an ASIC (Application Specific Integrated Circuit) <b>205</b> for image processing, a buffer memory <b>207</b>, a CPU <b>211</b>, a RAM <b>213</b>, a ROM (firmware memory) <b>215</b>, an image display portion <b>221</b>, a card interface <b>217</b> and a memory card <b>219</b>.</p>
<p id="p-0087" num="0092">ASIC <b>205</b> includes, as its inner modules, a Retinex processing circuit <b>251</b>, a color interpolation circuit <b>253</b>, a gamma correcting circuit <b>255</b>, a color space converting circuit <b>257</b> and an image compressing circuit <b>259</b>.</p>
<p id="p-0088" num="0093">In ASIC <b>205</b>, the modules successively process the output of A/D converter <b>203</b> in the sequence from right to left in the figure. The modules in ASIC <b>205</b> share buffer memory <b>207</b>, and CPU <b>211</b> performs the timing control for controlling the module accessing the memory.</p>
<p id="p-0089" num="0094">In this embodiment, the digital camera performs the Retinex processing on the RAW image subjected only to the A/D conversion, and the predetermined image processing is performed after the Retinex processing. Thereby, the Retinex processing can exhibit the original function of substantially modeling the functions of the retina and cortex of the living body.</p>
<p id="p-0090" num="0095">The circuit structure in <figref idref="DRAWINGS">FIG. 4</figref> can be applied to digital video cameras, scanners and film scanners.</p>
<heading id="h-0009" level="1">Fifht Embodiment</heading>
<p id="p-0091" num="0096"><figref idref="DRAWINGS">FIG. 5</figref> is a block diagram showing a structure of a computer executing a program in a fifth embodiment of the invention.</p>
<p id="p-0092" num="0097">Referring to <figref idref="DRAWINGS">FIG. 5</figref>, the computer includes a CPU <b>301</b> for controlling the entire apparatus, a display portion <b>303</b>, a LAN (Local Area Network) card <b>305</b> for connection to a network or external communication, an input portion <b>307</b> formed of a keyboard, a mouse or the like, a flexible disk drive <b>309</b>, a CD-ROM drive <b>311</b>, a hard disk drive <b>313</b>, a ROM <b>315</b> and a RAM <b>317</b>.</p>
<p id="p-0093" num="0098">Programs, which are illustrated in flowcharts to be described later and are used for driving CPU (computer) <b>301</b>, can be recorded on a record medium such as a flexible disk (F<b>1</b>) and a CD-ROM (C<b>1</b>). The program is sent from the record medium to another record medium such as a RAM, and is recorded therein. The program may be provided to users in the form recorded in the record medium such as a hard disk, ROM, RAM or memory card. The program may be downloaded over the Internet from an external site to a work station or a computer for execution.</p>
<p id="p-0094" num="0099"><figref idref="DRAWINGS">FIG. 6</figref> is a flowchart representing the Retinex processing executed by the computer in <figref idref="DRAWINGS">FIG. 5</figref>.</p>
<p id="p-0095" num="0100">Referring to <figref idref="DRAWINGS">FIG. 6</figref>, analog data D<b>1</b> obtained by the CCD is converted into data D<b>2</b> of a RAW image by the A/D converter in a step S<b>101</b>. In a next step S<b>103</b>, data D<b>2</b> is subjected to Fourier transform by the computer.</p>
<p id="p-0096" num="0101">In a step S<b>105</b>, Gaussian peripheral function D<b>3</b> is subjected to the Fourier transform. In a step S<b>107</b>, multiplication is performed in a frequency region of the data obtained in steps S<b>103</b> and S<b>105</b>. Thereafter, inverse Fourier transform is performed in a step S<b>109</b> so that a blurred image D<b>4</b> is obtained.</p>
<p id="p-0097" num="0102">In a step S<b>111</b>, D<b>2</b> is divided by D<b>4</b>, and a logarithm of the result is obtained in a step S<b>113</b> to provide a Retinex output D<b>5</b>.</p>
<p id="p-0098" num="0103">Thereafter, gamma correction (step S<b>115</b>), other image processing (step S<b>117</b>), clipping processing (step S<b>119</b>) and 8-bit allocation (step S<b>121</b>) are effected on the Retinex output. Thereafter, the image is displayed in a step S<b>123</b>.</p>
<p id="p-0099" num="0104"><figref idref="DRAWINGS">FIG. 7</figref> is a flowchart illustrating the linear Retinex processing executed by the computer in <figref idref="DRAWINGS">FIG. 5</figref>.</p>
<p id="p-0100" num="0105">Referring to <figref idref="DRAWINGS">FIG. 7</figref>, the processing in steps S<b>101</b>-S<b>111</b> is the same as that in <figref idref="DRAWINGS">FIG. 6</figref>, and therefore, description thereof is not repeated. The division in step S<b>111</b> provides a Retinex output D<b>6</b>. In this embodiment, output D<b>6</b> is subjected to gamma correction (correction of (⅓)th power of D<b>6</b>) in a step S<b>118</b>. Thereafter, clipping processing (step S<b>119</b>), 8-bit allocation (step S<b>121</b>) and display processing (step S<b>123</b>) are performed.</p>
<p id="p-0101" num="0106">The foregoing image processing may be effected on image data sent over the Internet or other communication line, and the results of the image processing may be sent to another apparatus over the communication line.</p>
<heading id="h-0010" level="1">Sixth Embodiment</heading>
<p id="p-0102" num="0107">For example, by using the Fourier transform in the convolution integral as described above, the operation can be performed fast.</p>
<p id="p-0103" num="0108">However, images are usually two-dimensional, and processing such as FFT and DFT must be executed on the real type data. Therefore, for executing FFT{F(x, y)} and FFT(I<sub>i</sub>(x, y)} in formula (4), a very large memory is required. When a recent personal computer with one gigabytes of memory is used, images of a relatively low resolution (e.g., VGA: 640×480) can be processed fast without any problem, but images of a relatively high resolution (e.g., FULL: 2560×1920) may not be completely processed due to insufficient memory. Therefore, the above manner is not sufficiently practical under the present circumstances.</p>
<p id="p-0104" num="0109">In the sixth embodiment, the following processing is performed in the Retinex processing illustrated in connection with the first to fifth embodiments and the prior art for overcoming the foregoing problems.</p>
<p id="p-0105" num="0110">First, an original image Low_I<sub>i</sub>(x, y) is prepared by temporarily lowering the resolution of original image I<sub>i</sub>(x, y). A blurred image is prepared from image Low_I<sub>i</sub>(x, y).</p>
<p id="p-0106" num="0111">As manners of converting the resolution, Zero Order, Bi-Linear, Quadratic and Cubic Spline have been known, and one of these manners can be used.</p>
<p id="p-0107" num="0112">For example, a filter image Low_F(x, y) of a low resolution providing the same image size as original image Low_I<sub>i</sub>(x, y) of a low resolution is used (i.e., Low_F(x, y) of 640×480 is used when Low_I<sub>i</sub>(x, y) has a resolution of 640×480), and the convolution integral in formula (7) or the multiplication and inverse FFT processing in the frequency region are executed for producing a blurred image.
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?>Low<sub>—</sub><i>F</i>(<i>x, y</i>)*Low<sub>—</sub><i>I</i><sub>i</sub>(<i>x, y</i>)=FFT<sup>−1</sup>{FFT{Low<sub>—</sub><i>F</i>(<i>x, y</i>)}·FFT{Low<sub>—</sub><i>I</i><sub>i</sub>(<i>x, y</i>)}}  (7)<?in-line-formulae description="In-line Formulae" end="tail"?>
</p>
<p id="p-0108" num="0113">Naturally, the blurred image produced in formula (7) has the resolution different from that of original image I<sub>i</sub>(x, y) so that the calculation in formula (1) cannot be executed without further processing.</p>
<p id="p-0109" num="0114">For executing the calculation in formula (1), it is necessary to match the resolutions of the original and blurred images with each other, and the resolution of the blurred image produced by the formula (7) is changed to match with the resolution of original image I<sub>i</sub>(x, y) by interpolation (likewise, by a manner of Zero Order, Bi-Linear, Quadratic or Cubic Spline).</p>
<p id="p-0110" num="0115">This processing may use the same manner as the conversion manner previously used for lowering the resolution of original image I<sub>i</sub>(x, y), or may use another conversion manner. By producing the blurred image as described above, the Retinex processing of high-resolution images can be executed fast.</p>
<p id="p-0111" num="0116"><figref idref="DRAWINGS">FIG. 8</figref> illustrates a structure of the Retinex processing portion of the image processing apparatus of the sixth embodiment.</p>
<p id="p-0112" num="0117">Referring to <figref idref="DRAWINGS">FIG. 8</figref>, the Retinex processing portion includes an interpolating portion <b>401</b> for performing an interpolating operation to reduce the resolution of original image D<b>2</b>, a blurred image producing portion <b>403</b> for producing a blurred image by processing the image of a lowered resolution provided by interpolating portion <b>401</b> with a filter, and an interpolating portion <b>405</b> for providing the same resolution as original image D<b>2</b>. A Retinex processing portion <b>407</b> performs the Retinex processing based on original image D<b>2</b> and the output image of interpolating portion <b>405</b>.</p>
<heading id="h-0011" level="1">Seventh Embodiment</heading>
<p id="p-0113" num="0118">In the sixth embodiment, an image quality (precision) of the output image can be adjusted by changing a degree of lowering of the resolution by interpolating portion <b>401</b>. For example, present digital cameras are configured to save digital image data in various resolutions, which are classified into FULL (2,560×1,920), UXGA (1,600×1,200), SXGA (1,280×960), XGA (1,024×768) and VGA (640×480) in the order of magnitude.</p>
<p id="p-0114" num="0119">Accordingly, if prime importance is placed on the image quality, e.g., of the original image of FULL (2,560×1,920), UXGA (1,600×1,200) is selected as the lowered resolution of the original image. If the prime importance is placed on the speed, VGA (640×480) is selected as the lowered resolution of the original image. This processing is performed by interpolating portion <b>401</b>. In this manner, the blurred image having the resolution, which depends on the selected importance, is produced, and is restored to have the resolution of FULL (2,560×1,920) by the interpolation processing of interpolating portion <b>405</b>, and Retinex processing portion <b>407</b> executes the processing.</p>
<p id="p-0115" num="0120">Further, the technique of this embodiment may be applied to the Retinex processing of the MSR type.</p>
<p id="p-0116" num="0121">In the case where the original image has the resolution, e.g., of FULL (2,560×1,920), the blurred images, which are blurred to large, medium and small extents, are produced from original images having the lowered resolutions of VGA (640×480), SXGA (1,200×960) and UXGA (1,600×1,200), respectively. Thereafter, the respective blurred images are restored to have the original resolution of FULL (2,560×1,920) by the interpolating processing, and the Retinex processing and combining are performed.</p>
<p id="p-0117" num="0122">Thus, in the case where the image is blurred only to a small extent, the resolution is not lowered to a large extent so that an effect of maintaining the image quality (precision) can be expected.</p>
<p id="p-0118" num="0123">In connection with the application to the MSR described above, the size of the filter for blurring the target image may be variable relatively to the size of the target image. Thereby, it is possible to prepare a plurality of images blurred to different extents, respectively. Accordingly, the blurred images, which are blurred to large, medium and small extents, can be produced from the images prepared by lowering the resolution of the original image to VGA (640×480), SXGA (1,200×960) and UXGA (1,600×1,200) with the filter of the same size, respectively, and are restored to the resolution of the original image, whereby the images blurred to large, medium and small extents can be produced. Processing is performed to divide the original image by each of the images blurred to large, medium and small extents (see <figref idref="DRAWINGS">FIG. 19</figref>) so that MSR can be achieved.</p>
<p id="p-0119" num="0124">Conversely, if digital image data of different resolutions (e.g., UXGA (1,600×1,200) and VGA (640×480)) are processed to produce the blurred images by the Gaussian function having the peripheral spread of the same size, it is apparent that the result of processing of each data is different from that of the other.</p>
<p id="p-0120" num="0125">Although the resolutions are different from each other, the contents of these images are the same, and it is not preferable that the result of color correction, contrast and degree of edge enhancement vary depending on the resolution. Accordingly, the size of the filter for producing the blurred images is changed depending on the resolution of the images (output images of interpolating portion <b>401</b> shown in <figref idref="DRAWINGS">FIG. 8</figref>), from which the blurred images are produced. Thereby, uniform processing effects can be achieved even when the resolutions are different.</p>
<p id="p-0121" num="0126">For example, <figref idref="DRAWINGS">FIGS. 9 and 10</figref> are graphs schematically illustrating Gaussian functions having similar peripheral spreads in a one-dimensional manner. In these graphs, X-axis gives the positions of the pixels.</p>
<p id="p-0122" num="0127"><figref idref="DRAWINGS">FIG. 9</figref> is the graph illustrating, in the one-dimensional manner, the spread along the X-axis of the Gaussian function applied to the VGA (640×480) image of a low resolution. <figref idref="DRAWINGS">FIG. 10</figref> is the graph illustrating, in the one-dimensional manner, the spread along the X-axis of the Gaussian function applied to the UXGA (1,600×1,200) image of a high resolution.</p>
<p id="p-0123" num="0128">These Gaussian functions are different from each other, and have different spreads, respectively. However, forms of curves thereof are geometrically similar when whole images are viewed.</p>
<p id="p-0124" num="0129">By changing the Gaussian function in accordance with the resolution, both the images having the same contents can be processed to achieve similar Retinex effect.</p>
<p id="p-0125" num="0130">As described above, the spread of the Gaussian function is changed for providing geometrically similar forms even when the resolutions are different as described above. This can be achieved by adjusting constant c (kernel value) determining the peripheral spread in the Gaussian function of the formula (2) together with the resolution.</p>
<p id="p-0126" num="0131">For example, it is assumed that a kernel value C<sub>VGA </sub>is applied to VGA (640×480), and a kernel value of C<sub>UXGA </sub>is applied to UXGA (1,600×1,200). In this case, the kernel values can be easily calculated by the following formula:
<br/>
<?in-line-formulae description="In-line Formulae" end="lead"?><i>C</i><sub>VGA</sub><i>=C</i><sub>UXGA</sub>×(640/1600)   (8)<?in-line-formulae description="In-line Formulae" end="tail"?>
</p>
<p id="p-0127" num="0132">In <figref idref="DRAWINGS">FIG. 11</figref>, it is assumed that the image, from which blurred images are to be formed, has the resolution of FULL (2560×1920), and a kernel value C<sub>FULL </sub>corresponds to this FULL resolution. <figref idref="DRAWINGS">FIG. 11</figref> illustrates formulas for calculating kernel values, which correspond to the respective resolutions of UXGA (1,600×1,200), SXGA (1,280×960), XGA (1,024×768) and VGA (640×480), from a kernel value C<sub>FULL</sub>, respectively.</p>
<p id="p-0128" num="0133">The blurred images are produced from images of different resolutions by changing the kernel value, and are subjected to the Retinex processing. This processing can be executed, e.g., inside a digital camera. Alternatively, the processing may be effected on digital image data saved as images of certain resolutions by application software installed in a personal computer or the like.</p>
<p id="p-0129" num="0134">If functions other than the Gaussian functions shown in <figref idref="DRAWINGS">FIGS. 9 and 10</figref> are to be used, such functions can be likewise used by changing the filter sizes of respective functions together with the resolutions of the images.</p>
<p id="p-0130" num="0135">For example, <figref idref="DRAWINGS">FIG. 12</figref> illustrates, in a one-dimensional manner, peripheral spreads of different four functions, each of which has a weight of one in a center pixel (pixel of interest) represented at a position of the origin.</p>
<p id="p-0131" num="0136">In <figref idref="DRAWINGS">FIG. 12</figref>, a line <b>1</b> represents a Gaussian function of exp(−(x/c<sub>1</sub>)<sup>2</sup>, a line <b>2</b> represents an exponential function of exp(−|x|/c<sub>2</sub>), a line <b>3</b> represents an inverse square function of 1/(1+(x/c<sub>3</sub>)<sup>2</sup>), and a line <b>4</b> represents a linear function of (c<sub>4</sub>−x)·c<sub>4</sub>. Accordingly, c<sub>1</sub>, c<sub>2</sub>, c<sub>3 </sub>and c<sub>4 </sub>correspond to the kernel values in the respective peripheral spread functions. Accordingly, by selecting the kernel values of c<sub>1</sub>, c<sub>2</sub>, c<sub>3 </sub>and c<sub>4</sub>, the blurred images can be prepared in accordance with the resolution.</p>
<heading id="h-0012" level="1">Eigth Embodiment</heading>
<p id="p-0132" num="0137">In the sixth embodiment, interpolating portion <b>401</b> may be configured to lower the resolution by a degree corresponding to the resolution of original image D<b>2</b>, whereby the image processing can be performed with the same filter.</p>
<p id="p-0133" num="0138"><figref idref="DRAWINGS">FIG. 13</figref> illustrates processing in an eighth embodiment, and particularly the processing performed by interpolating portion <b>401</b>, blurred image producing portion <b>403</b> and interpolating portion <b>405</b> in <figref idref="DRAWINGS">FIG. 8</figref>.</p>
<p id="p-0134" num="0139">Referring to <figref idref="DRAWINGS">FIG. 13</figref>, a resolution converting portion <b>451</b> converts the resolutions in accordance with the resolution of original image D<b>2</b> to provide images of the same resolution. In <figref idref="DRAWINGS">FIG. 13</figref>, a VGA image is produced by the resolution conversion regardless of the resolution (i.e., FULL, UXGA, SXGA, XGA or VGA) of original image D<b>2</b>.</p>
<p id="p-0135" num="0140">Thereafter, a blurred image producing portion <b>453</b> produces a blurred image with a filter, and a resolution converting portion <b>455</b> restores the resolution to the original resolution. In this processing, the images provided by resolution converting portion <b>451</b> have the uniform resolution regardless of the resolution of original image D<b>2</b>. Therefore, the blurred images blurred to the substantially same extent can be obtained by using the filter of the same size even if the resolution of the original image changes.</p>
<p id="p-0136" num="0141">For example, it is assumed that a plurality of images have the same contents and different resolutions, respectively. Any one of these images of different resolutions can be subjected to the processing in <figref idref="DRAWINGS">FIG. 13</figref> to provide the blurred image, which is blurred to a substantially uniform extent when viewed as a whole, and the Retinex processing can be performed to a substantially uniform extent.</p>
<p id="p-0137" num="0142">In this embodiment, processing is performed to adjust a relative magnitude or size between the target image to be blurred and the filter, whereby the Retinex processing can be performed to a substantially uniform extent regardless of the resolution of the image to be processed.</p>
<heading id="h-0013" level="1">Ninth Embodiment</heading>
<p id="p-0138" num="0143"><figref idref="DRAWINGS">FIG. 14</figref> is a flowchart illustrating the Retinex processing in a ninth embodiment of the invention.</p>
<p id="p-0139" num="0144">Referring to <figref idref="DRAWINGS">FIG. 14</figref>, the flowchart differs from the flowchart of <figref idref="DRAWINGS">FIG. 6</figref> in that interpolation (resolution conversion) of original image D<b>2</b> is performed in step S<b>102</b> for producing a blurred image. After the blurred image is produced, interpolation is performed in a step S<b>110</b> to match the resolution with that of original image D<b>2</b>.</p>
<p id="p-0140" num="0145">Kernel value c, which determines the spread of the Gaussian function, is determined in accordance with the level of the interpolation in a step S<b>151</b>.</p>
<p id="p-0141" num="0146">Other processing is the same as that in the flowchart of <figref idref="DRAWINGS">FIG. 6</figref>.</p>
<p id="p-0142" num="0147">For performing, e.g., MSR, the value of c is kept fixed in step S<b>151</b>, and the level of resolution conversion is changed in step S<b>102</b> to produce a plurality of images. Thereby, a plurality of images at different blurred levels can be prepared with the same filter. Alternatively, the resolution may be converted to a uniform level, and the value of c may be changed to produce a plurality of images at different blurred levels.</p>
<p id="p-0143" num="0148"><figref idref="DRAWINGS">FIG. 15</figref> is a flowchart likewise illustrating the linear Retinex processing illustrated in <figref idref="DRAWINGS">FIG. 7</figref>, and particularly the processing, in which the resolution of the original image is changed to set the value of c before producing the blurred image.</p>
<heading id="h-0014" level="1">Tenth Embodiment</heading>
<p id="p-0144" num="0149">Instead of producing the blurred image from the original image with the Gaussian function and others, the blurred image can be produced by optically setting an unfocused state, or by using an image pickup element of a low resolution. In the case where an unfocused state is optically attained, the image pickup element such as a CCD for recording the original image may be used also as the image pickup element for recording the blurred image, or may be different therefrom.</p>
<p id="p-0145" num="0150">The Retinex processing is performed on the original image and blurred image having the same resolution.</p>
<p id="p-0146" num="0151"><figref idref="DRAWINGS">FIG. 16</figref> is a block diagram showing a structure of a digital camera of the tenth embodiment.</p>
<p id="p-0147" num="0152">This digital camera differs from the digital camera (<figref idref="DRAWINGS">FIG. 4</figref>) of the fourth embodiment in that the digital camera in <figref idref="DRAWINGS">FIG. 16</figref> includes a half mirror <b>253</b> and a CCD <b>251</b> for producing a blurred image. Instead of the half mirror, another lens may be used for applying light to CCD <b>251</b>. However, in view of parallax, which may occur when shooting an object at a shot distance, it is desired to use the half mirror for leading the light coming from the same optical system to two lines.</p>
<p id="p-0148" num="0153">In <figref idref="DRAWINGS">FIG. 16</figref>, CCD <b>251</b> is located in a position, where it can obtain a blurred image when CCD <b>201</b> focuses.</p>
<p id="p-0149" num="0154">For the blurred image, an image pickup element, which has a lower resolution and thus is cheaper than that for the original image, can be used. In this case, the low resolution of the image for the blurred image is matched with the resolution of the image pickup element for the original image by interpolation, whereby it is possible to perform substantially the same processing as the Retinex processing performed on the blurred image produced from the image of the resolution, which is lowered as described above.</p>
<heading id="h-0015" level="1">Eleventh Embodiment</heading>
<p id="p-0150" num="0155"><figref idref="DRAWINGS">FIG. 17</figref> is a flowchart illustrating image pickup processing of a digital camera in an eleventh embodiment.</p>
<p id="p-0151" num="0156">This processing is executed by CPU <b>211</b> of the digital camera (<figref idref="DRAWINGS">FIG. 4</figref>) in the fourth embodiment.</p>
<p id="p-0152" num="0157">Referring to <figref idref="DRAWINGS">FIG. 17</figref>, a lens control portion <b>209</b> performs lens drive processing for focusing (step S<b>301</b>). When a shutter is released (YES in step S<b>303</b>), CCD image pickup element <b>201</b> shoots original image D<b>2</b> in a step S<b>305</b>. Thereafter, lens control portion <b>209</b> drives the lens in a step S<b>307</b> to attain an unfocused state. In this state, blurred image D<b>4</b> is obtained in a step S<b>309</b>.</p>
<p id="p-0153" num="0158">Thereafter, the Retinex processing is performed based on images D<b>2</b> and D<b>4</b> (step S<b>311</b>), and image correcting processing is performed (step S<b>313</b>). Then, image output (display or memory storage) is performed (step S<b>315</b>).</p>
<p id="p-0154" num="0159">When performing the MSR, the unfocused state is attained to different extents in steps S<b>307</b> and S<b>309</b>, whereby blurred images at different levels are obtained.</p>
<p id="p-0155" num="0160">According to the tenth and eleventh embodiments, it is not necessary to perform complicated operations such as convolution integral for producing the blurred images. Therefore, it is possible to provide an image pickup apparatus capable of fast Retinex processing.</p>
<p id="p-0156" num="0161">The invention can be applied to digital cameras, digital video cameras, scanners, film scanners and other digital devices.</p>
<p id="p-0157" num="0162">Although the present invention has been described and illustrated in detail, it is clearly understood that the same is by way of illustration and example only and is not to be taken by way of limitation, the spirit and scope of the present invention being limited only by the terms of the appended claims.</p>
<?DETDESC description="Detailed Description" end="tail"?>
</description>
<us-claim-statement>What is claimed is:</us-claim-statement>
<claims id="claims">
<claim id="CLM-00001" num="00001">
<claim-text>1. An image processing program product recorded on a computer readable medium for executing a Retinex processing program by a computer, said Retinex processing is performed by the following steps:
<claim-text>receiving a RAW image to be processed,</claim-text>
<claim-text>producing a blurred image from said received RAW image, and</claim-text>
<claim-text>executing the Retinex processing based on said RAW image and said blurred image.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00002" num="00002">
<claim-text>2. The image processing program product according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein said RAW image is data obtained immediately after A/D conversion effected on an electric signal from an image pickup device.</claim-text>
</claim>
<claim id="CLM-00003" num="00003">
<claim-text>3. The image processing program product according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein a predetermined gamma correction is effected on said RAW image after effecting the Retinex processing on said RAW image.</claim-text>
</claim>
<claim id="CLM-00004" num="00004">
<claim-text>4. The image processing program product according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein said Retinex processing includes processing of dividing said RAW image by said blurred image of said RAW image.</claim-text>
</claim>
<claim id="CLM-00005" num="00005">
<claim-text>5. An image processing program product recorded on a computer readable medium for executing a Retinex processing program by a computer, said Retinex processing is performed by the following steps:
<claim-text>a first step of producing an image by lowering a resolution of an original image to be processed,</claim-text>
<claim-text>a second step of producing a blurred image from said image produced by lowering the resolution of said original image,</claim-text>
<claim-text>a third step of restoring the resolution of said blurred image to the resolution of said original image, and</claim-text>
<claim-text>a fourth step of executing said Retinex processing based on said original image and said blurred image having the resolution restored to the resolution of said original image.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00006" num="00006">
<claim-text>6. The image processing program product according to <claim-ref idref="CLM-00005">claim 5</claim-ref>, wherein
<claim-text>said first step produces said image by converting the resolution of said original image to a predetermined resolution, and</claim-text>
<claim-text>said second step produces said blurred image by using a filter of a predetermined size.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00007" num="00007">
<claim-text>7. The image processing program product according to <claim-ref idref="CLM-00005">claim 5</claim-ref>, wherein
<claim-text>said first step produces said image by converting the resolution of said original image to a given resolution, and</claim-text>
<claim-text>said second step produces said blurred image by using a filter of a size matching with said given resolution.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00008" num="00008">
<claim-text>8. The image processing program product according to <claim-ref idref="CLM-00007">claim 7</claim-ref>, wherein
<claim-text>said second step includes a changing step of changing the filter size, and</claim-text>
<claim-text>said changing step produces a Gaussian filter having a peripheral spread corresponding to a resolution of said image produced by temporarily lowering the resolution of the original image by changing a kernel value in the Gaussian filter in accordance with the resolution of each image.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00009" num="00009">
<claim-text>9. An image processing program product recorded on a computer readable medium for executing a Multi-Scale Retinex processing program by a computer, wherein said computer executes:
<claim-text>a first step of producing a plurality of images by lowering a resolution of an original image to be processed to multiple levels,</claim-text>
<claim-text>a second step of producing a blurred image of each of said plurality of images by using a predetermined filter,</claim-text>
<claim-text>a third step of restoring the resolutions of said plurality of produced blurred images to the resolution of said original image, and</claim-text>
<claim-text>a fourth step of executing Multi-Scale Retinex processing based on said original image and said plurality of blurred images having the resolutions restored to the resolution of said original image.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00010" num="00010">
<claim-text>10. An image processing program product recorded on a computer readable medium for executing a Multi-Scale Retinex processing program by a computer, wherein said computer executes:
<claim-text>a first step of preparing a plurality of images including an original image by producing at least one image of a lower resolution from the original image to be processed,</claim-text>
<claim-text>a second step of producing blurred images from at least two of said plurality of images by using a predetermined filter,</claim-text>
<claim-text>a third step of restoring the resolution of each of said at least two blurred images to the resolution of said original image if said at least two blurred images have the resolutions different from the resolution of said original image, and</claim-text>
<claim-text>a fourth step of executing said Multi-Scale Retinex processing based on said original image and said at least two blurred images having the resolution of said original image.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00011" num="00011">
<claim-text>11. An image pickup apparatus for executing a Retinex processing program, comprising:
<claim-text>an image pickup device for producing an original image to be processed,</claim-text>
<claim-text>an optical means for optically producing a blurred image of said original image,</claim-text>
<claim-text>a computer readable medium on which said Retinex processing program is recorded, and the original image and the blurred image are recorded, and</claim-text>
<claim-text>a means for executing the Retinex processing program based on said original image and said blurred image to restore the image after Retinex processing to the resolution of the original image.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00012" num="00012">
<claim-text>12. The image pickup apparatus according to <claim-ref idref="CLM-00011">claim 11</claim-ref>, wherein said blurred image is produced from another image pickup device different from said image pickup device.</claim-text>
</claim>
<claim id="CLM-00013" num="00013">
<claim-text>13. The image pickup apparatus according to <claim-ref idref="CLM-00011">claim 11</claim-ref>, wherein said blurred image is produced by attaining an unfocused state in an optical system applying light to said image pickup device.</claim-text>
</claim>
<claim id="CLM-00014" num="00014">
<claim-text>14. An image processing apparatus for executing a Retinex processing program recorded on a computer readable medium, comprising:
<claim-text>a means for producing an original image;</claim-text>
<claim-text>a means for producing an image by lowering a resolution of said original image to be processed;</claim-text>
<claim-text>a means for producing a blurred image from the image produced by lowering the resolution of said original image;</claim-text>
<claim-text>a means for restoring the resolution of said blurred image to the resolution of said original image; and</claim-text>
<claim-text>a means for executing said Retinex processing program based on said original image and said blurred image having the resolution restored to the resolution of said original image.</claim-text>
</claim-text>
</claim>
<claim id="CLM-00015" num="00015">
<claim-text>15. An image processing apparatus for executing a Multi-Scale Retinex processing program encoded on a computer readable medium, comprising:
<claim-text>a means for producing an original image;</claim-text>
<claim-text>a means for producing a plurality of images by lowering a resolution of an original image to be processed to multiple levels,</claim-text>
<claim-text>a means for producing a blurred image of each of said plurality of images by using a predetermined filter,</claim-text>
<claim-text>a means for restoring the resolutions of said plurality of produced blurred images to the resolution of said original image, and</claim-text>
<claim-text>a means for executing said Multi-Scale Retinex processing program based on said original image and said plurality of blurred images having the resolutions restored to the resolution of said original image.</claim-text>
</claim-text>
</claim>
</claims>
</us-patent-grant>
